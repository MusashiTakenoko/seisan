<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>グレース目白204 立替購入申請</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --accent-2:#3b82f6; --ok:#16a34a; --warn:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.08); --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;
      color:var(--text);
      background: radial-gradient(80% 80% at 100% 0%, #eef2ff 0%, transparent 60%),
                  radial-gradient(80% 80% at 0% 100%, #f1f5f9 0%, transparent 60%),
                  var(--bg);
    }
    header{position:sticky; top:0; z-index:20; background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(10px); border-bottom:1px solid var(--border); box-shadow: var(--shadow);}
    .navwrap{display:flex; align-items:center; justify-content:space-between; max-width:1100px; margin:0 auto; padding:14px 18px}
    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .link{color:var(--accent); text-decoration:none; font-weight:600; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#fff}
    .link:hover{background:#f8fafc}
    main{max-width:1100px; margin:26px auto; padding:0 18px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow: var(--shadow)}
    .grid{display:grid; gap:14px}
    @media(min-width:860px){ .grid-2{grid-template-columns:1fr 1fr} }
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px 2px}
    input,select,button,textarea{
      width:100%; padding:12px 14px; border:1px solid var(--border);
      border-radius:14px; background:#fff; color:var(--text); font-size:16px; transition:.15s;
    }
    input::placeholder,textarea::placeholder{color:#9ca3af}
    input:focus,select:focus,textarea:focus,button:focus{outline:2px solid var(--accent); outline-offset:1px}
    textarea{resize:vertical; min-height:100px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn-primary{background:linear-gradient(180deg, var(--accent), var(--accent-2)); border-color:transparent; color:white; font-weight:700}
    .btn-primary:hover{filter:brightness(1.04)}
    .note{font-size:12px; color:var(--muted)}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:18px;
      background:#111827; color:#fff; padding:10px 14px; border-radius:12px; border:1px solid #111827;
      box-shadow: var(--shadow); opacity:0; transition:.25s;
    }
    .toast.show{opacity:1}
    .thumb{width:120px; height:120px; object-fit:cover; border:1px solid var(--border); border-radius:12px; display:none; margin-top:8px}
    .title-hero{
      font-size:22px; font-weight:800; letter-spacing:.3px; margin:0;
      background: linear-gradient(90deg,#0f172a, #1f2937); -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    /* select の矢印（ライト用） */
    select{
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23334155' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 12px center; padding-right:44px;
    }
    select option,select optgroup{background:#fff; color:#111827}
  </style>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // ▼▼▼ あなたの Firebase 設定に置き換え ▼▼▼
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "XXXX",
      appId: "1:XXXX:web:YYYY"
    };
    // ▲▲▲ ここまで ▲▲▲

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ====== Google Drive（必要時のみロード） ======
    const CLIENT_ID = "YOUR_GOOGLE_OAUTH_CLIENT_ID.apps.googleusercontent.com"; // ←置換
    const FOLDER_ID = "YOUR_DRIVE_FOLDER_ID";                                    // ←置換
    const DRIVE_SCOPE = "https://www.googleapis.com/auth/drive.file";
    let tokenClient = null, accessToken = null, gisLoaded = false, gisLoading = false;

    // ユーティリティ
    const $ = (id)=>document.getElementById(id);
    const getParam = (k)=>new URL(location.href).searchParams.get(k)||"";
    const room = getParam("room");
    const MEMBERS = ["やまかん","もりがく","こうすけ"];

    window.addEventListener("load", ()=>{
      $("linkDash").href = `./dashboard.html?room=${encodeURIComponent(room||"")}`;
      const d = new Date(); $("date").value = d.toISOString().slice(0,10);

      // 金額：カンマ自動付与
      $("amount").addEventListener("input", ()=>{
        const digits = $("amount").value.replace(/[^\d]/g,"");
        $("amount").value = digits ? Number(digits).toLocaleString("ja-JP") : "";
      });

      // メンバー選択
      const sel = $("payer");
      MEMBERS.forEach(n=>{ const o=document.createElement("option"); o.value=n; o.textContent=n; sel.appendChild(o); });

      // 画像プレビュー
      $("file").addEventListener("change", ()=>{
        const f = $("file").files[0];
        if(f && /^image\//.test(f.type)){ $("thumb").src = URL.createObjectURL(f); $("thumb").style.display="block"; }
        else $("thumb").style.display="none";
      });
    });

    // GIS を必要時にだけ動的ロード
    function ensureGisReady(){
      return new Promise((resolve, reject)=>{
        if (gisLoaded && tokenClient) return resolve();
        if (gisLoading) {
          const t = setInterval(()=>{ if(gisLoaded && tokenClient){ clearInterval(t); resolve(); } }, 100);
          setTimeout(()=>{ clearInterval(t); if(!gisLoaded) reject(new Error("GIS loading timeout")); }, 4000);
          return;
        }
        gisLoading = true;
        const s = document.createElement("script");
        s.src = "https://accounts.google.com/gsi/client"; s.async = true; s.defer = true;
        s.onload = ()=>{
          gisLoaded = true;
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: DRIVE_SCOPE, prompt: "",
            callback: (resp)=>{ if(resp.error){ toast("Google認可エラー: "+resp.error); return; }
              accessToken = resp.access_token; doUploadAndSave(); }
          });
          resolve();
        };
        s.onerror = ()=>reject(new Error("Google Identity Services を読み込めませんでした"));
        document.head.appendChild(s);
      });
    }

    function toast(msg){ const t=$("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 2200); }
    function parseAmountComma(v){ const n = Number(String(v).replace(/[,\s]/g,"")); return isFinite(n) ? n : 0; }

    // 送信
    window.handleSubmit = async (e)=>{
      e.preventDefault();
      $("submitBtn").disabled = true; $("submitBtn").textContent = "送信中…";

      const file = $("file").files[0];

      // ★ レシート未選択：そのまま保存（Googleログイン不要）
      if(!file){
        await savePurchase(null);
        $("submitBtn").disabled=false; $("submitBtn").textContent="登録";
        return;
      }

      // レシート選択時のみ、GIS をロード→認可→Driveへアップロード
      try{
        if(!CLIENT_ID || !FOLDER_ID || CLIENT_ID.includes("YOUR_GOOGLE_OAUTH_CLIENT_ID")){
          toast("レシート添付は現在オフです（管理者にCLIENT_IDとFOLDER_IDの設定を依頼してください）");
          await savePurchase(null);
          $("submitBtn").disabled=false; $("submitBtn").textContent="登録";
          return;
        }
        await ensureGisReady();
        if(accessToken){ await doUploadAndSave(); }
        else { tokenClient.requestAccessToken(); }
      }catch(err){
        toast(err.message||"Google連携の初期化に失敗しました");
        await savePurchase(null);
      }finally{
        $("submitBtn").disabled=false; $("submitBtn").textContent="登録";
      }
    };

    async function doUploadAndSave(){
      const file = $("file").files[0]; if(!file){ await savePurchase(null); return; }
      try{
        const metadata = { name: `${Date.now()}_${file.name}`, parents: [FOLDER_ID] };
        const boundary = "-------314159265358979323846";
        const delimiter = `\r\n--${boundary}\r\n`;
        const closeDelim = `\r\n--${boundary}--`;
        const metaPart = 'Content-Type: application/json; charset=UTF-8\r\n\r\n'+JSON.stringify(metadata);
        const fileHeader = `Content-Type: ${file.type || "application/octet-stream"}\r\n\r\n`;
        const arrBuf = await file.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(arrBuf)));
        const body = delimiter + metaPart + delimiter + fileHeader + base64 + closeDelim;

        const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink",{
          method:"POST",
          headers:{ "Authorization":"Bearer "+accessToken, "Content-Type":"multipart/related; boundary="+boundary },
          body
        });
        if(!res.ok){ toast("アップロード失敗（ログインや許可を確認）"); await savePurchase(null); return; }
        const data = await res.json();
        await savePurchase({ id:data.id, link:data.webViewLink });
        toast("保存しました ✅");
        $("form").reset(); $("thumb").style.display="none"; // 日付だけ再設定
        const d = new Date(); $("date").value = d.toISOString().slice(0,10);
      }catch(err){
        toast("アップロード中にエラー: "+err.message);
        await savePurchase(null);
      }
    }

    async function savePurchase(receipt){
      const title = $("title").value.trim();
      const amount = parseAmountComma($("amount").value);
      const payer = $("payer").value;
      const dateStr = $("date").value;
      const memo = $("memo").value.trim();

      if(!title || !amount || !payer || !dateStr){
        toast("未入力があります");
        return;
      }

      const dateObj = new Date(dateStr+"T00:00:00");
      try{
        await addDoc(collection(db,"purchases"),{
          room: room || null, title, amount, payer,
          date: Timestamp.fromDate(dateObj),
          memo: memo || null,
          receiptFileId: receipt?.id || null,
          receiptLink: receipt?.link || null,
          createdAt: serverTimestamp()
        });
        if(!receipt){ // レシートなし保存時のトースト
          toast("保存しました ✅（レシートなし）");
          $("form").reset(); $("thumb").style.display="none"; $("date").value = dateStr;
        }
      }catch(err){
        toast("保存エラー: "+err.message);
      }
    }
  </script>
</head>
<body>
  <header>
    <div class="navwrap">
      <h1 class="title-hero">グレース目白204 立替購入申請</h1>
      <a id="linkDash" class="link" href="./dashboard.html">ダッシュボード</a>
    </div>
  </header>

  <main>
    <form id="form" class="card" onsubmit="handleSubmit(event)">
      <div class="grid grid-2">
        <div>
          <label>品名（必須）</label>
          <input id="title" placeholder="例：キッチンペーパー" required />
        </div>
        <div>
          <label>金額（円・必須）</label>
          <input id="amount" type="tel" inputmode="numeric" placeholder="例：1,280" required />
        </div>

        <div>
          <label>購入者（必須）</label>
          <select id="payer" required>
            <option value="" disabled selected>選択してください</option>
          </select>
        </div>
        <div>
          <label>購入日（必須）</label>
          <input id="date" type="date" required />
        </div>

        <div style="grid-column:1/-1">
          <label>備考（任意）</label>
          <textarea id="memo" placeholder="例：洗剤まとめ買い。来月分と合わせて清算など"></textarea>
        </div>

        <div style="grid-column:1/-1">
          <label>レシート（任意／画像 or PDF）</label>
          <input id="file" type="file" accept="image/*,.pdf" />
          <img id="thumb" class="thumb" alt="preview">
          <div class="note" style="margin-top:6px">※ 未選択でも登録できます。対応拡張子：JPG / PNG / HEIC / PDF など（〜5MB目安）</div>
        </div>
      </div>

      <div class="actions" style="margin-top:10px">
        <button id="submitBtn" class="btn-primary" type="submit">登録</button>
        <span class="note">レシート無しの場合は事前にLINEで申告</span>
      </div>
    </form>

    <div class="toast" id="toast" aria-live="polite"></div>
  </main>
</body>
</html>
