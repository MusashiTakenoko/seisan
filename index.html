<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>グレース目白204 立替購入申請</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --accent-2:#3b82f6; --shadow:0 10px 30px rgba(0,0,0,.08); --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;
      color:var(--text);
      background: radial-gradient(80% 80% at 100% 0%, #eef2ff 0%, transparent 60%),
                  radial-gradient(80% 80% at 0% 100%, #f1f5f9 0%, transparent 60%),
                  var(--bg);
    }
    header{position:sticky; top:0; z-index:20; background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(10px); border-bottom:1px solid var(--border); box-shadow: var(--shadow);}
    .navwrap{display:flex; align-items:center; justify-content:space-between; max-width:1100px; margin:0 auto; padding:14px 18px}
    h1{font-size:18px; margin:0}
    .link{color:var(--accent); text-decoration:none; font-weight:600; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#fff}
    .link:hover{background:#f8fafc}
    main{max-width:1100px; margin:26px auto; padding:0 18px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow: var(--shadow)}
    .grid{display:grid; gap:14px}
    @media(min-width:860px){ .grid-2{grid-template-columns:1fr 1fr} }
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px 2px}
    input,select,button,textarea{
      width:100%; padding:12px 14px; border:1px solid var(--border);
      border-radius:14px; background:#fff; color:var(--text); font-size:16px; transition:.15s;
    }
    input::placeholder,textarea::placeholder{color:#9ca3af}
    input:focus,select:focus,textarea:focus,button:focus{outline:2px solid var(--accent); outline-offset:1px}
    textarea{resize:vertical; min-height:100px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn-primary{background:linear-gradient(180deg, var(--accent), var(--accent-2)); border-color:transparent; color:white; font-weight:700}
    .btn-primary:hover{filter:brightness(1.04)}
    .note{font-size:12px; color:var(--muted)}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:18px;
      background:#111827; color:#fff; padding:10px 14px; border-radius:12px; border:1px solid #111827;
      box-shadow: var(--shadow); opacity:0; transition:.25s; z-index:50;
    }
    .toast.show{opacity:1}
    .thumb{width:120px; height:120px; object-fit:cover; border:1px solid var(--border); border-radius:12px; display:none; margin-top:8px}
    .title-hero{
      font-size:22px; font-weight:800; margin:0;
      background: linear-gradient(90deg,#0f172a, #1f2937); -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    select{
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23334155' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 12px center; padding-right:44px;
    }
    select option,select optgroup{background:#fff; color:#111827}
  </style>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      initializeFirestore, collection, addDoc, serverTimestamp, Timestamp
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // ▼▼▼ あなたの Firebase 設定に置き換え ▼▼▼
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "XXXX",
      appId: "1:XXXX:web:YYYY"
    };
    // ▲▲▲ ここまで ▲▲▲

    const app = initializeApp(firebaseConfig);
    // ネットワーク環境でのハング回避
    const db  = initializeFirestore(app, { experimentalForceLongPolling: true });

    // ====== （必要時のみ）Google Drive アップロード用設定 ======
    const CLIENT_ID = "YOUR_GOOGLE_OAUTH_CLIENT_ID.apps.googleusercontent.com"; // ←置換
    const FOLDER_ID = "YOUR_DRIVE_FOLDER_ID";                                   // ←置換
    const DRIVE_SCOPE = "https://www.googleapis.com/auth/drive.file";
    let tokenClient = null, accessToken = null, gisLoaded = false, gisLoading = false;

    function ensureGisReady(timeoutMs = 4000){
      return new Promise((resolve)=>{
        if (gisLoaded && tokenClient) return resolve(true);
        if (gisLoading) {
          const started = Date.now();
          const t = setInterval(()=>{
            if (gisLoaded && tokenClient){ clearInterval(t); resolve(true); }
            else if (Date.now()-started > timeoutMs){ clearInterval(t); resolve(false); }
          }, 100);
          return;
        }
        gisLoading = true;
        const s = document.createElement("script");
        s.src = "https://accounts.google.com/gsi/client"; s.async = true; s.defer = true;
        s.onload = ()=>{
          gisLoaded = true;
          try{
            tokenClient = google.accounts.oauth2.initTokenClient({
              client_id: CLIENT_ID, scope: DRIVE_SCOPE, prompt: "",
              callback: (resp)=>{
                if(resp?.error){ toast("Google認可エラー: "+resp.error); return; }
                accessToken = resp.access_token;
                doUploadAndSave().catch(err=>{
                  toast("アップロード中にエラー: "+err.message);
                  savePurchase(null);
                });
              }
            });
            resolve(true);
          }catch{ resolve(false); }
        };
        s.onerror = ()=>resolve(false);
        document.head.appendChild(s);
      });
    }

    // ====== ユーティリティ ======
    const $ = (id)=>document.getElementById(id);
    const getParam = (k)=>new URL(location.href).searchParams.get(k)||"";
    const room = getParam("room");
    const MEMBERS = ["やまかん","もりがく","こうすけ"];

    // ① デバッグ出力エリアへログ
    function log(msg){
      console.log(msg);
      const el = document.getElementById("debug");
      if(el){ el.textContent = (el.textContent?el.textContent+"\n":"") + String(msg); }
    }
    // ② グローバルエラーハンドラ
    window.addEventListener("error", e => { log("onerror: "+(e?.message||e)); });
    window.addEventListener("unhandledrejection", e => { log("unhandledrejection: "+(e?.reason?.message||e.reason||e)); });

    // 全角→半角（数字/カンマ/ドット）
    function toHalfWidthDigits(str){
      return String(str).replace(/[０-９，．]/g, ch => {
        if (ch === '，') return ',';
        if (ch === '．') return '.';
        return String.fromCharCode(ch.charCodeAt(0) - 0xFEE0);
      });
    }
    // カンマ付き金額を数値へ（空は0、0円も許可）
    function parseAmountComma(v){
      const s = toHalfWidthDigits(String(v));
      const n = Number(s.replace(/[^\d]/g,""));
      return isFinite(n) ? n : 0;
    }
    function toast(msg){ const t=$("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 2400); }

    window.addEventListener("load", ()=>{
      $("linkDash").href = `./dashboard.html?room=${encodeURIComponent(room||"")}`;
      const d = new Date(); $("date").value = d.toISOString().slice(0,10);

      // 金額：全角→半角→カンマフォーマット
      $("amount").addEventListener("input", ()=>{
        const raw = toHalfWidthDigits($("amount").value);
        const digits = raw.replace(/[^\d]/g,"");
        $("amount").value = digits ? Number(digits).toLocaleString("ja-JP") : "";
      });

      // メンバー選択
      const sel = $("payer");
      MEMBERS.forEach(n=>{ const o=document.createElement("option"); o.value=n; o.textContent=n; sel.appendChild(o); });

      // 画像プレビュー
      $("file").addEventListener("change", ()=>{
        const f = $("file").files[0];
        if(f && /^image\//.test(f.type)){ $("thumb").src = URL.createObjectURL(f); $("thumb").style.display="block"; }
        else $("thumb").style.display="none";
      });
    });

    // ====== 送信処理（0円OK／レシート任意／必ず復帰） ======
    window.handleSubmit = async (e)=>{
      e.preventDefault();
      const btn = $("submitBtn");
      btn.disabled = true;
      btn.textContent = "送信中…";
      try{
        if (!$("date").value) { const d = new Date(); $("date").value = d.toISOString().slice(0,10); }

        const title = $("title").value.trim();
        const payer = $("payer").value;
        const dateStr = $("date").value;
        const amountStr = $("amount").value.trim();
        const amount = parseAmountComma(amountStr);

        // 0円OK／ただし金額欄が空文字はNG
        if(!title || !payer || !dateStr || amountStr===""){
          toast("未入力があります");
          return;
        }

        const file = $("file").files[0];

        // ③ レシート無し：シンプルに保存（ログ＆復帰）
        if(!file){
          try{
            log("saving without receipt…");
            await savePurchase(null, {title, amount, payer, dateStr});
            toast("保存しました ✅（レシートなし）");
            $("form").reset(); $("thumb").style.display="none";
            $("date").value = dateStr;
          }catch(err){
            log("save error (no receipt): "+(err?.message||err));
            toast("保存に失敗しました: "+(err?.message||err));
          }
          return;
        }

        // レシート有り：Drive設定が未完ならレシート無しで保存
        if(!CLIENT_ID || !FOLDER_ID || CLIENT_ID.includes("YOUR_GOOGLE_OAUTH_CLIENT_ID")){
          try{
            await savePurchase(null, {title, amount, payer, dateStr});
            toast("Drive未設定のためレシートなしで保存しました。");
            $("form").reset(); $("thumb").style.display="none"; $("date").value = dateStr;
          }catch(err){
            log("save error (no receipt; drive unconfigured): "+(err?.message||err));
            toast("保存に失敗しました: "+(err?.message||err));
          }
          return;
        }

        const ok = await ensureGisReady(4000);
        if(!ok || !tokenClient){
          try{
            await savePurchase(null, {title, amount, payer, dateStr});
            toast("Google連携を初期化できず、レシートなしで保存しました。");
            $("form").reset(); $("thumb").style.display="none"; $("date").value = dateStr;
          }catch(err){
            log("save error (no receipt; gis failed): "+(err?.message||err));
            toast("保存に失敗しました: "+(err?.message||err));
          }
          return;
        }

        // 認可要求（成功時は callback 内で doUploadAndSave → savePurchase）
        tokenClient.requestAccessToken();

      }catch(err){
        log("handleSubmit exception: "+(err?.message||err));
        toast("送信中エラー: "+(err?.message||err));
      }finally{
        btn.disabled = false;
        btn.textContent = "登録";
      }
    };

    async function doUploadAndSave(){
      const file = $("file").files[0];
      if(!file){ await savePurchase(null); return; }
      try{
        const metadata = { name: `${Date.now()}_${file.name}`, parents: [FOLDER_ID] };
        const boundary = "-------314159265358979323846";
        const delimiter = `\r\n--${boundary}\r\n`;
        const closeDelim = `\r\n--${boundary}--`;
        const metaPart = 'Content-Type: application/json; charset=UTF-8\r\n\r\n'+JSON.stringify(metadata);
        const fileHeader = `Content-Type: ${file.type || "application/octet-stream"}\r\n\r\n`;
        const arrBuf = await file.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(arrBuf)));
        const body = delimiter + metaPart + delimiter + fileHeader + base64 + closeDelim;

        const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink",{
          method:"POST",
          headers:{ "Authorization":"Bearer "+accessToken, "Content-Type":"multipart/related; boundary="+boundary },
          body
        });

        if(!res.ok){
          toast("レシートのアップロードに失敗しました。レシートなしで保存します。");
          await savePurchase(null);
          return;
        }
        const data = await res.json();
        await savePurchase({ id:data.id, link:data.webViewLink });
        toast("保存しました ✅");
        $("form").reset(); $("thumb").style.display="none";
        $("date").value = new Date().toISOString().slice(0,10);
      }catch(err){
        log("doUploadAndSave error: "+(err?.message||err));
        toast("アップロード中にエラー: "+(err?.message||err));
        await savePurchase(null);
      }
    }

    // ④ savePurchase：例外は握りつぶさず呼び出し元に投げる
    async function savePurchase(receipt, preset){
      const title = preset?.title ?? $("title").value.trim();
      const payer = preset?.payer ?? $("payer").value;
      const dateStr = preset?.dateStr ?? $("date").value;
      const amount = preset?.amount ?? parseAmountComma($("amount").value);
      const memo = $("memo").value.trim();
      const dateObj = new Date(dateStr+"T00:00:00");

      return addDoc(collection(db,"purchases"),{
        room: (new URL(location.href).searchParams.get("room")) || null,
        title, amount, payer,
        date: Timestamp.fromDate(dateObj),
        memo: memo || null,
        receiptFileId: receipt?.id || null,
        receiptLink: receipt?.link || null,
        createdAt: serverTimestamp()
      });
    }
  </script>
</head>
<body>
  <header>
    <div class="navwrap">
      <h1 class="title-hero">グレース目白204 立替購入申請</h1>
      <a id="linkDash" class="link" href="./dashboard.html">ダッシュボード</a>
    </div>
  </header>

  <main>
    <form id="form" class="card" onsubmit="handleSubmit(event)">
      <div class="grid grid-2">
        <div>
          <label>品名（必須）</label>
          <input id="title" placeholder="例：キッチンペーパー" required />
        </div>
        <div>
          <label>金額（円・必須／0円可）</label>
          <input id="amount" type="tel" inputmode="numeric" placeholder="例：1,280（全角でもOK）" required />
        </div>

        <div>
          <label>購入者（必須）</label>
          <select id="payer" required>
            <option value="" disabled selected>選択してください</option>
          </select>
        </div>
        <div>
          <label>購入日（必須）</label>
          <input id="date" type="date" required />
        </div>

        <div style="grid-column:1/-1">
          <label>備考（任意）</label>
          <textarea id="memo" placeholder="例：洗剤まとめ買い。来月分と合わせて清算など"></textarea>
        </div>

        <div style="grid-column:1/-1">
          <label>レシート（任意／画像 or PDF）</label>
          <input id="file" type="file" accept="image/*,.pdf" />
          <img id="thumb" class="thumb" alt="preview">
          <div class="note" style="margin-top:6px">※ 未選択でも登録できます。対応拡張子：JPG / PNG / HEIC / PDF など（〜5MB目安）</div>
        </div>
      </div>

      <div class="actions" style="margin-top:10px">
        <button id="submitBtn" class="btn-primary" type="submit">登録</button>
        <span class="note">レシート無しの場合は事前にLINEで申告</span>
      </div>
    </form>

    <!-- ① デバッグログ表示（必要に応じて外してOK） -->
    <pre id="debug" style="white-space:pre-wrap;font-size:12px;color:#ef4444;margin-top:10px"></pre>

    <div class="toast" id="toast" aria-live="polite"></div>
  </main>
</body>
</html>
